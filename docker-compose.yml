services:
  datafordeler:
    container_name: datafordeler
    image: datafordeler:latest
    build:
      context: .
      dockerfile: docker/Dockerfile
    depends_on:
      - datafordeler-db
    env_file:
      - ./docker/dev-env/datafordeler.env
    volumes:
      - ./docker/dev-env/sts_metadata.xml:/app/conf/sts_metadata.xml:ro
      - ./plugin/cpr/src/test/resources/GLBASETEST:/app/dev-env/local/cpr/download/d170608.l534902
      - ./plugin/cpr/src/test/resources/GLBASETEST2:/app/dev-env/local/cpr/download/d170610.l534901
#      - ./plugin/cvr/src/test/resources/company_in.json:/app/dev-env/local/cvr/company_in.json
      - ./plugin/cvr/src/test/resources/unit.json:/app/dev-env/local/cvr/unit.json
      - ./plugin/cvr/src/test/resources/person.json:/app/dev-env/local/cvr/person.json
      - ./plugin/geo/src/test/resources/municipality.json:/app/dev-env/local/geo/municipality.json
      - ./plugin/geo/src/test/resources/locality.json:/app/dev-env/local/geo/locality.json
      - ./plugin/geo/src/test/resources/post.json:/app/dev-env/local/geo/post.json
      - ./plugin/geo/src/test/resources/road.json:/app/dev-env/local/geo/road.json
      - ./plugin/geo/src/test/resources/access.json:/app/dev-env/local/geo/access.json
      - ./plugin/geo/src/test/resources/unit.json:/app/dev-env/local/geo/unit.json
      - ./plugin/geo/src/test/resources/building.json:/app/dev-env/local/geo/building.json
      - ./docker/createdbs.sql:/app/createdbs.sql
      - ./plugin/cpr/pom.xml:/code/plugin/cpr/pom.xml:ro
    environment:
      - DATABASE_IMPORT_FILES=/app/createdbs.sql
    ports:
      - 8080:80
    command: [
      "java",
      "-Dloader.path=/app/plugin/jar/",
      "--add-opens", "java.base/java.net=ALL-UNNAMED",
      "--add-opens", "java.base/java.lang.invoke=ALL-UNNAMED",
      "-Xms128M", "-Xmx4096M",
      "-Dterminal.jline=false", "-Dterminal.ansi=true",
      "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005",
      "-cp", "datafordeler-core-exec.jar",
      "org.springframework.boot.loader.launch.PropertiesLauncher"
    ]

  datafordeler-db:
    container_name: datafordeler-db
    build:
      context: .
      dockerfile: docker/Dockerfile.sqlserver
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=testTEST1
    ports:
      - "1434:1433"
    volumes:
      - ./docker/dev-env/local:/app/dev-env/local
      - ./docker/dev-env/db/initiate-db.sql:/app/initiate-db.sql
      - ./docker/manual_initiate.sh:/app/manual_initiate.sh

  test:
    container_name: datafordeler-test
    profiles:
      - donotstart
    image: datafordeler:latest
    env_file:
      - ./docker/dev-env/datafordeler.env
    depends_on:
      - datafordeler-db
    # command: bash -c "cd /code/core && mvn --batch-mode test"
    command: bash -c "cd /code/plugin/ger && mvn test"
    # command: bash -c "cd /code/plugin/cpr && mvn test"
    # command: bash -c "cd /code/plugin/cvr && mvn test"
    #use docker compose up test to execute tests

  openapi:
    build:
      context: .
      dockerfile: docker/Dockerfile.openapi
    ports:
      - "8081:8080"

volumes:
  datafordeler-gl:
