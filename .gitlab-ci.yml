stages:
  - build
  - test

variables:
  IMAGE_DEV: ${CI_REGISTRY_IMAGE}:dev
  IMAGE_SQL: ${CI_REGISTRY_IMAGE}:sql

.build-default: &build-default
  stage: build
  tags:
    - docker
  image:
    # We use the `:debug` image as it contains `sh` needed by gitlab-ci.
    name: gcr.io/kaniko-project/executor:debug-v0.16.0
    entrypoint: [ "" ]

build-mssql-image:
  <<: *build-default
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - cat /kaniko/.docker/config.json
    - /kaniko/executor
      --context=${CI_PROJECT_DIR}
      --dockerfile=${CI_PROJECT_DIR}/docker/Dockerfile.sqlserver
      --destination=${IMAGE_SQL}
      --cache=true

build-image:
  <<: *build-default
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - cat /kaniko/.docker/config.json
    - /kaniko/executor
      --context=${CI_PROJECT_DIR}
      --dockerfile=${CI_PROJECT_DIR}/docker/Dockerfile
      --destination=${IMAGE_DEV}
      --cache=true


.test-default: &test-default
  stage: test
  needs:
    - build-mssql-image
    - build-image
  image: ${IMAGE_DEV}
  variables:
    GIT_STRATEGY: none
    JAVA_OPTS: "-Duser.timezone=Europe/Copenhagen"
    #M$ sql variables
    ACCEPT_EULA: "Y"
    SA_PASSWORD: "testTEST1"
  tags:
    - docker
  services:
    - name: ${IMAGE_SQL}
      alias: datafordeler-db


test-core:
  <<: *test-default
  before_script:
    - cd /code/core
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/core/target/surefire-reports/*.xml

test-cpr:
  <<: *test-default
  before_script:
    - cd /code/plugin/cpr
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/plugin/cpr/target/surefire-reports/TEST-*

test-cvr:
  <<: *test-default
  before_script:
    - cd /code/plugin/cvr
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit: target/surefire-reports/*.xml

test-eboks:
  <<: *test-default
  before_script:
    - cd /code/plugin/eboks
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/plugin/eboks/target/surefire-reports/*.xml

test-eskat:
  <<: *test-default
  before_script:
    - cd /code/plugin/eskat
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/plugin/eskat/target/surefire-reports/*.xml

test-geo:
  <<: *test-default
  before_script:
    - cd /code/plugin/geo
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/plugin/geo/target/surefire-reports/*.xml

test-ger:
  <<: *test-default
  before_script:
    - cd /code/plugin/ger
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/plugin/ger/target/surefire-reports/*.xml

test-prisme:
  <<: *test-default
  before_script:
    - cd /code/plugin/prisme
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/plugin/prisme/target/surefire-reports/*.xml

test-combinedPitu:
  <<: *test-default
  before_script:
    - cd /code/plugin/combinedPitu
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/plugin/pituCombined/target/surefire-reports/TEST-*.xml

test-statistik:
  <<: *test-default
  before_script:
    - cd /code/plugin/statistik
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit:
        - /code/plugin/statistik/target/surefire-reports/*.xml

test-subscription:
  <<: *test-default
  before_script:
    - cd /code/plugin/subscription
  script:
    - mvn --batch-mode -T 2C test
  artifacts:
    reports:
      junit: /code/plugin/subscription/target/surefire-reports/*.xml
