image: maven:3-jdk-11

stages:
  - build
  - test

variables:
  IMAGE_SHA: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}
  IMAGE_DEV: ${CI_REGISTRY_IMAGE}:dev

build-image:
  stage: build
  tags:
    - docker
  image:
    # We use the `:debug` image as it contains `sh` needed by gitlab-ci.
    name: gcr.io/kaniko-project/executor:debug-v0.16.0
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context=${CI_PROJECT_DIR}
      --dockerfile=${CI_PROJECT_DIR}/ci/dockerFile
      --destination=${IMAGE_DEV}
      --cache=true

.test-default: &test-default
  stage: test
  variables:
    GIT_STRATEGY: none
  needs:
    - build-image
  image:
    name: ${IMAGE_DEV}
  tags:
    - docker
  script:
    - mvn --batch-mode -T 2C test

test-core:
  <<: *test-default
  before_script:
    - cd /app/core

test-cpr:
  <<: *test-default
  before_script:
    - cd /app/plugin/cpr

test-geo:
  <<: *test-default
  before_script:
    - cd /app/plugin/geo

test-cvr:
  <<: *test-default
  before_script:
    - cd /app/plugin/cvr

test-ger:
  <<: *test-default
  before_script:
    - cd /app/plugin/ger

test-eboks:
  <<: *test-default
  before_script:
    - cd /app/plugin/eboks

test-prisme:
  <<: *test-default
  before_script:
    - cd /app/plugin/prisme


